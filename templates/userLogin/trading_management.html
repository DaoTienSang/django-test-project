{% extends 'userLogin/base_sidebar.html' %}

{% load humanize %}
{% load static %}

{% block title %}Qu·∫£n l√Ω Giao d·ªãch - SmartTrade{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'userLogin/css/trading_management.css' %}">
{% endblock %}

{% block main-content %}
<main class="trading-content">
    <div class="trading-header">
        <h2>Qu·∫£n l√Ω Giao d·ªãch</h2>
    </div>

    <!-- Th·∫ª th√¥ng tin v√≠ v√† danh m·ª•c -->
    <div class="info-cards">
        <div class="info-card">
            <div class="info-icon">üí∞</div>
            <div class="info-details">
                <h3>S·ªë d∆∞ kh·∫£ d·ª•ng</h3>
                <p class="info-amount">{{ user.balance|intcomma}} VND</p>
            </div>
        </div>
        <div class="info-card">
            <div class="info-icon">üìà</div>
            <div class="info-details">
                <h3>Gi√° tr·ªã danh m·ª•c</h3>
                <p class="info-amount">{{ portfolio_value|intcomma }} VND</p>
            </div>
        </div>
        <div class="info-card">
            <div class="info-icon">üîÑ</div>
            <div class="info-details">
                <h3>Giao d·ªãch th√°ng n√†y</h3>
                <p class="info-amount">{{ monthly_transactions_count }} giao d·ªãch</p>
            </div>
        </div>
    </div>

    <!-- Tabs Mua/B√°n -->
    <div class="trading-tabs">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="buy">Mua c·ªï phi·∫øu</button>
            <button class="tab-btn" data-tab="sell">B√°n c·ªï phi·∫øu</button>
        </div>
        
        <!-- Tab n·ªôi dung Mua -->
        <div class="tab-content active" id="buy-tab">
            <div class="trading-form-container">
                <form class="trading-form" method="post" action="">
                    <!-- 'userLogin:buy_stock' -->
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="buy-stock-code">M√£ c·ªï phi·∫øu</label>
                        <select name="stock-code" id="buy-stock-code" required>
                            <option value="">Ch·ªçn m√£ c·ªï phi·∫øu</option>
                            {% for stock in list_stock_market %}
                            <option value="{{ stock.stock_code }}">{{ stock.ticker }} - {{ stock.organ_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="buy-stock-price">Gi√° hi·ªán t·∫°i (VND)</label>
                        <input type="text" id="buy-stock-price" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="buy-stock-amount">S·ªë l∆∞·ª£ng</label>
                        <input name="stock-amount" type="number" id="buy-stock-amount" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën mua" required>
                    </div>
                    
                    <div class="form-group total-section">
                        <label>T·ªïng gi√° tr·ªã</label>
                        <p class="total-value" id="buy-total-value">0 VND</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">X√°c nh·∫≠n mua</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Tab n·ªôi dung B√°n -->
        <div class="tab-content" id="sell-tab">
            <div class="trading-form-container">
                <form class="trading-form" method="post" action="">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="sell-stock-code">C·ªï phi·∫øu ƒëang s·ªü h·ªØu</label>
                        <select name="stock-code" id="sell-stock-code" required>
                            <option value="">Ch·ªçn m√£ c·ªï phi·∫øu</option>
                            {% for stock in user_stocks %}
                            <option value="{{ stock.stock_code }}">{{ stock.stock_code }} - {{ stock.stock.company_name }} (S·ªü h·ªØu: {{ stock.amount }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sell-stock-price">Gi√° hi·ªán t·∫°i (VND)</label>
                        <input type="text" id="sell-stock-price" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="sell-stock-amount">S·ªë l∆∞·ª£ng b√°n</label>
                        <input name="stock-amount" type="number" id="sell-stock-amount" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n" required>
                        <p class="available-amount">ƒêang s·ªü h·ªØu: <span id="owned-amount">0</span></p>
                    </div>
                    
                    <div class="form-group total-section">
                        <label>T·ªïng gi√° tr·ªã</label>
                        <p class="total-value" id="sell-total-value">0 VND</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">X√°c nh·∫≠n b√°n</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- L·ªãch s·ª≠ giao d·ªãch -->
    <div class="trading-history">
        <div class="history-header">
            <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
            <div class="history-filter">
                <select id="transaction-type-filter">
                    <option value="all">T·∫•t c·∫£ giao d·ªãch</option>
                    <option value="buy">Mua</option>
                    <option value="sell">B√°n</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√£ giao d·ªãch</th>
                        <th>Ng√†y</th>
                        <th>M√£ c·ªï phi·∫øu</th>
                        <th>Lo·∫°i giao d·ªãch</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√°</th>
                        <th>T·ªïng gi√° tr·ªã</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transaction_history %}
                    <tr class="transaction-row ">
                        <td>#{{ transaction.id }}</td>
                        <td>{{ transaction.time|date:"d/m/Y H:i" }}</td>
                        <td>{{ transaction.stock.stock_code }}</td>
                        <td class="transaction-type ">
                            B√°n
                            {# {{ "B√°n" if transaction.is_sell else "Mua" }} #}
                        </td>
                        <td>{{ transaction.amount }}</td>
                        <td>{{ transaction.price|intcomma }} VND</td>
                        <td>{{ transaction.total_value|intcomma }} VND</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="no-data">Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Danh m·ª•c ƒë·∫ßu t∆∞ -->
    <div class="portfolio-section">
        <div class="portfolio-header">
            <h3>Danh m·ª•c ƒë·∫ßu t∆∞</h3>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√£ c·ªï phi·∫øu</th>
                        <th>T√™n c√¥ng ty</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√° hi·ªán t·∫°i</th>
                        <th>Gi√° tr·ªã hi·ªán t·∫°i</th>
                        <th>L√£i/L·ªó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in portfolio %}
                    <tr>
                        <td>{{ item.stock.stock_code }}</td>
                        <td>{{ item.stock.company_name }}</td>
                        <td>{{ item.amount }}</td>
                        <td>{{ item.current_price|intcomma }} VND</td>
                        <td>{{ item.current_value|intcomma }} VND</td>
                        loss
                        {# <td class="{{ 'profit' if item.profit_loss > 0 else 'loss' if item.profit_loss < 0 else '' }}"> #}
                            {{ item.profit_loss|intcomma }} VND
                            {% if item.profit_loss > 0 %}
                            <span class="trend-up">&#9650;</span>
                            {% elif item.profit_loss < 0 %}
                            <span class="trend-down">&#9660;</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="no-data">Ch∆∞a c√≥ c·ªï phi·∫øu n√†o trong danh m·ª•c</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // X·ª≠ l√Ω tabs
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // Hide all tab contents
                tabContents.forEach(content => content.classList.remove('active'));
                // Show the selected tab content
                const tabId = this.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // X·ª≠ l√Ω l·ªçc l·ªãch s·ª≠ giao d·ªãch
        const transactionFilter = document.getElementById('transaction-type-filter');
        if (transactionFilter) {
            transactionFilter.addEventListener('change', function() {
                const filterValue = this.value;
                const rows = document.querySelectorAll('.transaction-row');
                
                rows.forEach(row => {
                    if (filterValue === 'all') {
                        row.style.display = '';
                    } else if (filterValue === 'buy' && row.classList.contains('buy-row')) {
                        row.style.display = '';
                    } else if (filterValue === 'sell' && row.classList.contains('sell-row')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        // Gi·∫£ l·∫≠p API l·∫•y gi√° c·ªï phi·∫øu
        const stockPrices = {
            {% for stock in stocks %}
            '{{ stock.stock_code }}': {{ stock.current_price|default:10000 }},
            {% endfor %}
        };
        
        // X·ª≠ l√Ω ch·ªçn c·ªï phi·∫øu v√† t√≠nh to√°n gi√° tr·ªã khi mua
        const buyStockSelect = document.getElementById('buy-stock-code');
        const buyStockPrice = document.getElementById('buy-stock-price');
        const buyStockAmount = document.getElementById('buy-stock-amount');
        const buyTotalValue = document.getElementById('buy-total-value');
        
        if (buyStockSelect) {
            buyStockSelect.addEventListener('change', function() {
                const selectedStock = this.value;
                if (selectedStock && stockPrices[selectedStock]) {
                    const price = stockPrices[selectedStock];
                    buyStockPrice.value = price.toLocaleString('vi-VN') + ' VND';
                    updateBuyTotal();
                } else {
                    buyStockPrice.value = '';
                    buyTotalValue.textContent = '0 VND';
                }
            });
        }
        
        if (buyStockAmount) {
            buyStockAmount.addEventListener('input', updateBuyTotal);
        }
        
        function updateBuyTotal() {
            const selectedStock = buyStockSelect.value;
            const amount = parseInt(buyStockAmount.value) || 0;
            
            if (selectedStock && stockPrices[selectedStock] && amount > 0) {
                const price = stockPrices[selectedStock];
                const total = price * amount;
                buyTotalValue.textContent = total.toLocaleString('vi-VN') + ' VND';
            } else {
                buyTotalValue.textContent = '0 VND';
            }
        }
        
        // X·ª≠ l√Ω ch·ªçn c·ªï phi·∫øu v√† t√≠nh to√°n gi√° tr·ªã khi b√°n
        const sellStockSelect = document.getElementById('sell-stock-code');
        const sellStockPrice = document.getElementById('sell-stock-price');
        const sellStockAmount = document.getElementById('sell-stock-amount');
        const sellTotalValue = document.getElementById('sell-total-value');
        const ownedAmount = document.getElementById('owned-amount');
        
        // Map l∆∞u tr·ªØ s·ªë l∆∞·ª£ng c·ªï phi·∫øu s·ªü h·ªØu c·ªßa m·ªói m√£
        const stockOwned = {
            {% for stock in user_stocks %}
            '{{ stock.stock.stock_code }}': {{ stock.amount }},
            {% endfor %}
        };
        
        if (sellStockSelect) {
            sellStockSelect.addEventListener('change', function() {
                const selectedStock = this.value;
                if (selectedStock && stockPrices[selectedStock]) {
                    const price = stockPrices[selectedStock];
                    sellStockPrice.value = price.toLocaleString('vi-VN') + ' VND';
                    ownedAmount.textContent = stockOwned[selectedStock] || 0;
                    updateSellTotal();
                } else {
                    sellStockPrice.value = '';
                    ownedAmount.textContent = '0';
                    sellTotalValue.textContent = '0 VND';
                }
            });
        }
        
        if (sellStockAmount) {
            sellStockAmount.addEventListener('input', updateSellTotal);
        }
        
        function updateSellTotal() {
            const selectedStock = sellStockSelect.value;
            const amount = parseInt(sellStockAmount.value) || 0;
            
            if (selectedStock && stockPrices[selectedStock] && amount > 0) {
                const price = stockPrices[selectedStock];
                const total = price * amount;
                sellTotalValue.textContent = total.toLocaleString('vi-VN') + ' VND';
                
                // Ki·ªÉm tra s·ªë l∆∞·ª£ng c√≥ qu√° s·ªë l∆∞·ª£ng s·ªü h·ªØu kh√¥ng
                const owned = stockOwned[selectedStock] || 0;
                if (amount > owned) {
                    sellStockAmount.setCustomValidity('S·ªë l∆∞·ª£ng b√°n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng s·ªü h·ªØu');
                } else {
                    sellStockAmount.setCustomValidity('');
                }
            } else {
                sellTotalValue.textContent = '0 VND';
            }
        }
        
    });
</script>
{% endblock %}