{% extends 'userLogin/base_sidebar.html' %}

{% load humanize %}
{% load static %}

{% block title %}Qu·∫£n l√Ω N·∫°p ti·ªÅn - SmartTrade{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'userLogin/css/deposit_management.css' %}">
{% endblock %}

{% block main-content %}
<main class="deposit-content">
    <div class="deposit-header">
        <h2>Qu·∫£n l√Ω N·∫°p ti·ªÅn</h2>
        <!-- <button class="btn-new-deposit">+ T·∫°o l·ªánh n·∫°p m·ªõi</button> -->
    </div>

    

    <!-- Th·∫ª th√¥ng tin v√≠ -->
    <div class="wallet-info-cards">
        <div class="wallet-card">
            <div class="wallet-icon">üí∞</div>
            <div class="wallet-details">
                <h3>S·ªë d∆∞ kh·∫£ d·ª•ng</h3>
                <p class="wallet-amount">{{ user.balance|intcomma}} VND</p>
            </div>
        </div>
        <div class="wallet-card">
            <div class="wallet-icon">üìä</div>
            <div class="wallet-details">
                <h3>T·ªïng n·∫°p th√°ng n√†y</h3>
                <p class="wallet-amount">{{amount_deposit_amonth|intcomma}} VND</p>
            </div>
        </div>
    </div>

    <!-- Form n·∫°p ti·ªÅn -->
    <div class="deposit-form-container">
        <div class="form-header">
            <h3>Th√¥ng tin n·∫°p ti·ªÅn</h3>
            <!-- <p>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</p> -->
        </div>
        <form class="deposit-form" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="deposit-amount">S·ªë ti·ªÅn n·∫°p (VND)</label>
                <input name="deposit-amount" type="text" id="deposit-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn b·∫°n mu·ªën n·∫°p..." required>
                <p class="info-text">S·ªë ti·ªÅn t·ªëi thi·ªÉu: 100,000 VND</p>
                <label for="deposit-description">N·ªôi dung</label>
                <textarea name="deposit-description" id="deposit-description" placeholder="Nh·∫≠p n·ªôi dung n·∫°p ti·ªÅn..." required></textarea>
            </div>
            <div class="form-group">
                <label for="bank-info">Th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng</label>
                <select name="bank-info" id="bank-info" required>
                    <option value="">Ch·ªçn t√†i kho·∫£n ng√¢n h√†ng</option>
                    {% for bank in user_banks %}
                    <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_number }}</option>
                    {% endfor %}
                </select>
                <a href="#" class="add-bank-link">+ Th√™m t√†i kho·∫£n m·ªõi</a>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-submit">X√°c nh·∫≠n n·∫°p</button>
            </div>
        </form>
    </div>

    <!-- L·ªãch s·ª≠ n·∫°p ti·ªÅn -->
    <div class="deposit-history">
        <div class="history-header">
            <h3>L·ªãch s·ª≠ n·∫°p ti·ªÅn</h3>
            <div class="history-filter">
                <select>
                    <option>T·∫•t c·∫£</option>
                    <option>Ho√†n th√†nh</option>
                    <option>ƒêang x·ª≠ l√Ω</option>
                    <option>B·ªã h·ªßy</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√£ giao d·ªãch</th>
                        <th>Ng√†y</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>N·ªôi dung</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                    {% for h in history_deposit %}
                    <tr>
                        <td>{{h.id}}</td>
                        <td>{{h.time}}</td>
                        <td>{{h.amount|intcomma}} VND</td>
                        <td>{{h.description}}</td>
                        <td class="status {%if h.status == 'P' %}
                                        status-processing
                                        {% elif h.status == 'C' %}
                                        status-completed
                                        {% else %}
                                        status-cancalled
                                        {% endif %}"><p>{{h.get_status_display}}</p></td>
                        <td><button class="btn-detail">Chi ti·∫øt</button></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="no-data">Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal th√™m t√†i kho·∫£n ng√¢n h√†ng -->
    <div id="add-bank-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Th√™m t√†i kho·∫£n ng√¢n h√†ng</h3>
            <form id="add-bank-form" method="post" action="{% url 'userLogin:add_bank_account' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="bank-name">T√™n ng√¢n h√†ng</label>
                    <select name="bank-name" id="bank-name" required>
                        <option value="">Ch·ªçn ng√¢n h√†ng</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="ACB">ACB</option>
                        <option value="TPBank">TPBank</option>
                        <option value="Sacombank">Sacombank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="account-number">S·ªë t√†i kho·∫£n</label>
                    <input type="text" id="account-number" name="account-number" required>
                </div>
                <div class="form-group">
                    <label for="account-name">T√™n ch·ªß t√†i kho·∫£n</label>
                    <input type="text" id="account-name" name="account-name" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Th√™m t√†i kho·∫£n</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal chi ti·∫øt giao d·ªãch -->
    <div id="transaction-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Chi ti·∫øt giao d·ªãch</h3>
            <div id="transaction-detail-content">
                <!-- N·ªôi dung chi ti·∫øt giao d·ªãch s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
        </div>
    </div>
</main>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // - Format s·ªë ti·ªÅn khi nh·∫≠p
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        if (withdrawAmountInput) {
            withdrawAmountInput.addEventListener('input', function(e) {
                // X√≥a t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
                let value = this.value.replace(/\D/g, '');
                // Format v·ªõi d·∫•u ph·∫©y ngƒÉn c√°ch h√†ng ngh√¨n
                if (value) {
                    this.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                } else {
                    this.value = '';
                }
            });
        }
        // - Th√™m t√†i kho·∫£n ng√¢n h√†ng
        const addBankLink = document.querySelector('.add-bank-link');
        const addBankModal = document.getElementById('add-bank-modal');
        const closeButtons = document.querySelectorAll('.close');
        
        // M·ªü modal th√™m t√†i kho·∫£n
        addBankLink.addEventListener('click', function(e) {
            e.preventDefault();
            addBankModal.style.display = 'block';
        });
        
        // ƒê√≥ng modal
        closeButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                addBankModal.style.display = 'none';
                transactionDetailModal.style.display = 'none';
            });
        });

        // const addBankLink = document.querySelector('.add-bank-link');
        // const addBankModal = document.getElementById('add-bank-modal');
        // const closeButtons = document.querySelectorAll('.close');
        
        // // M·ªü modal th√™m t√†i kho·∫£n
        // addBankLink.addEventListener('click', function(e) {
        //     e.preventDefault();
        //     addBankModal.style.display = 'block';
        // });
        
        // // ƒê√≥ng modal
        // closeButtons.forEach(function(button) {
        //     button.addEventListener('click', function() {
        //         addBankModal.style.display = 'none';
        //         transactionDetailModal.style.display = 'none';
        //     });
        // });

        const depositForm = document.querySelector('.deposit-form');
        
        // NgƒÉn ch·∫∑n submit m·∫∑c ƒë·ªãnh v√† hi·ªÉn th·ªã modal
        depositForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = document.getElementById('deposit-amount').value;
            const description = document.getElementById('deposit-description').value;
            
            // Ki·ªÉm tra s·ªë ti·ªÅn h·ª£p l·ªá
            const amountValue = parseFloat(amount.replace(/,/g, ''));
            if (isNaN(amountValue) || amountValue < 100000) {
                alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá (t·ªëi thi·ªÉu 100,000 VND)');
                return;
            }
            
            // T·∫°o modal ƒë·ªông
            createConfirmationModal(amount, description);
        });
        
        // Format s·ªë ti·ªÅn khi nh·∫≠p
        const depositAmount = document.getElementById('deposit-amount');
        depositAmount.addEventListener('input', function() {
            // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            let value = this.value.replace(/[^\d]/g, '');
            
            // Format v·ªõi d·∫•u ph·∫©y ngƒÉn c√°ch h√†ng ngh√¨n
            if (value) {
                this.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }else {
                this.value = '';
            }
        });
        
        // H√†m t·∫°o modal x√°c nh·∫≠n
        function createConfirmationModal(amount, description) {
            // T·∫°o c√°c ph·∫ßn t·ª≠ HTML cho modal
            const modal = document.createElement('div');
            modal.className = 'confirmation-modal';
            
            const modalContent = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h4>X√°c nh·∫≠n n·∫°p ti·ªÅn</h4>
                    </div>
                    <div class="modal-body">
                        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·∫°p <span class="amount">${amount}</span> VND?</p>
                        <p>N·ªôi dung: <span>${description || '(Kh√¥ng c√≥)'}</span></p>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" id="cancelDeposit">H·ªßy b·ªè</button>
                        <button class="btn-confirm" id="confirmDeposit">X√°c nh·∫≠n</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Th√™m event listener cho n√∫t h·ªßy
            modal.querySelector('#cancelDeposit').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Th√™m event listener cho n√∫t x√°c nh·∫≠n
            modal.querySelector('#confirmDeposit').addEventListener('click', function() {
                depositForm.submit();
            });
        }
        // ======= h√†m xem chi ti·∫øt n·∫°p ti·ªÅn
        const detailButtons = document.querySelectorAll('.btn-detail');
        const transactionDetailModal = document.getElementById('transaction-detail-modal');
    
        // X·ª≠ l√Ω n√∫t chi ti·∫øt
        detailButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // console.log('alsdfhdsfsdf');
                const transactionId = this.getAttribute('data-id');
                // G·ªçi API ƒë·ªÉ l·∫•y chi ti·∫øt giao d·ªãch
                fetchTransactionDetail(transactionId);
                transactionDetailModal.style.display = 'block';
            });
        });
        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.addEventListener('click', function(event) {
            if (event.target == addBankModal) {
                addBankModal.style.display = 'none';
            }
            if (event.target == transactionDetailModal) {
                transactionDetailModal.style.display = 'none';
            }
        });
        // H√†m l·∫•y nƒÉm, th√°ng, ng√†y, gi·ªù, ph√∫t, gi√¢y
        function formatISODate(isoString) {
            const date = new Date(isoString);
    
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Th√°ng t·ª´ 0-11, c·∫ßn +1
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
    
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    });


</script>

{% endblock %}