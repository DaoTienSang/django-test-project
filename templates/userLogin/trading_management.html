{% extends 'userLogin/base_sidebar.html' %}

{% load humanize %}
{% load static %}

{% block title %}Qu·∫£n l√Ω Giao d·ªãch - SmartTrade{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'userLogin/css/trading_management.css' %}">
{% endblock %}

{% block main-content %}
<main class="trading-content">
    <div class="trading-header">
        <h2>Qu·∫£n l√Ω Giao d·ªãch</h2>
    </div>

    <!-- Th·∫ª th√¥ng tin v√≠ v√† danh m·ª•c -->
    <div class="info-cards">
        <div class="info-card">
            <div class="info-icon">üí∞</div>
            <div class="info-details">
                <h3>S·ªë d∆∞ kh·∫£ d·ª•ng</h3>
                <p class="info-amount">{{ user.balance|intcomma}} VND</p>
            </div>
        </div>
        <!-- <div class="info-card">
            <div class="info-icon">üìà</div>
            <div class="info-details">
                <h3>Gi√° tr·ªã danh m·ª•c</h3>
                <p class="info-amount">{{ portfolio_value|intcomma }} VND</p>
            </div>
        </div> -->
        <div class="info-card">
            <div class="info-icon">üîÑ</div>
            <div class="info-details">
                <h3>Giao d·ªãch th√°ng n√†y</h3>
                <p class="info-amount">{{ monthly_transactions_count }} giao d·ªãch</p>
            </div>
        </div>
    </div>

    <!-- Tabs Mua/B√°n -->
    <div class="trading-tabs">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="buy">Mua c·ªï phi·∫øu</button>
            <button class="tab-btn" data-tab="sell">B√°n c·ªï phi·∫øu</button>
        </div>
        
        <!-- Tab n·ªôi dung Mua -->
        <div class="tab-content active" id="buy-tab">
            <div class="trading-form-container">
                <form class="trading-form" id="buy-stock-form" method="post" action="{% url 'userLogin:buy_stock' %}">
                    <!-- 'userLogin:buy_stock' -->
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="buy-stock-code">M√£ c·ªï phi·∫øu</label>
                        <select name="stock-code" id="buy-stock-code" required>
                            <option value="">Ch·ªçn m√£ c·ªï phi·∫øu</option>
                            {% for stock in list_stock_market %}
                            <option value="{{stock.ticker}}">{{ stock.ticker }} - {{ stock.organ_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="buy-stock-price">Gi√° hi·ªán t·∫°i (VND)</label>
                        <input type="text" name="stock-price" id="buy-stock-price" placeholder="Nh·∫≠p gi√° mu·ªën mua...">
                    </div>
                    
                    <div class="form-group">
                        <label for="buy-stock-amount">S·ªë l∆∞·ª£ng</label>
                        <input name="stock-amount" type="number" id="buy-stock-amount" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën mua" required>
                    </div>
                    
                    <div class="form-group total-section">
                        <label>T·ªïng gi√° tr·ªã</label>
                        <p class="total-value" id="buy-total-value">0 VND</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Mua</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal x√°c nh·∫≠n mua c·ªï phi·∫øu -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>X√°c nh·∫≠n giao d·ªãch</h2>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán giao d·ªãch sau?</p>
            <div class="confirmation-details">
                <p><strong>M√£ c·ªï phi·∫øu:</strong> <span id="confirm-stock-code"></span></p>
                <p><strong>Gi√°:</strong> <span id="confirm-stock-price"></span> VND</p>
                <p><strong>S·ªë l∆∞·ª£ng:</strong> <span id="confirm-stock-amount"></span></p>
                <p><strong>T·ªïng gi√° tr·ªã:</strong> <span id="confirm-total-value"></span> VND</p>
            </div>
            <div class="modal-actions">
                <button id="cancel-transaction" class="btn-cancel">H·ªßy</button>
                <button id="confirm-transaction" class="btn-confirm">X√°c nh·∫≠n</button>
            </div>
            </div>
        </div>
        
        <!-- Tab n·ªôi dung B√°n -->
        <div class="tab-content" id="sell-tab">
            <div class="trading-form-container">
                <form class="trading-form" method="post" action="{% url 'userLogin:sell_stock' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="sell-stock-code">C·ªï phi·∫øu ƒëang s·ªü h·ªØu</label>
                        <select name="stock-code" id="sell-stock-code" required>
                            <option value="">Ch·ªçn m√£ c·ªï phi·∫øu</option>
                            {% for stock in user_stocks %}
                            <option value="{{ stock.stock_code }}">{{ stock.stock_code }} - {{ stock.stock.company_name }} (S·ªü h·ªØu: {{ stock.amount }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sell-stock-price">Gi√° hi·ªán t·∫°i (VND)</label>
                        <input type="text" name="stock-price" id="sell-stock-price">
                    </div>
                    
                    <div class="form-group">
                        <label for="sell-stock-amount">S·ªë l∆∞·ª£ng b√°n</label>
                        <input name="stock-amount" type="number" id="sell-stock-amount" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n" required>
                        <p class="available-amount">ƒêang s·ªü h·ªØu: <span id="owned-amount">0</span></p>
                    </div>
                    
                    <div class="form-group total-section">
                        <label>T·ªïng gi√° tr·ªã</label>
                        <p class="total-value" id="sell-total-value">0 VND</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">X√°c nh·∫≠n b√°n</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal x√°c nh·∫≠n b√°n c·ªï phi·∫øu -->
        <div id="sell-confirmation-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>X√°c nh·∫≠n giao d·ªãch b√°n</h2>
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán giao d·ªãch b√°n sau?</p>
                <div class="confirmation-details">
                    <p><strong>M√£ c·ªï phi·∫øu:</strong> <span id="sell-confirm-stock-code"></span></p>
                    <p><strong>Gi√°:</strong> <span id="sell-confirm-stock-price"></span> VND</p>
                    <p><strong>S·ªë l∆∞·ª£ng:</strong> <span id="sell-confirm-stock-amount"></span></p>
                    <p><strong>T·ªïng gi√° tr·ªã:</strong> <span id="sell-confirm-total-value"></span> VND</p>
                </div>
                <div class="modal-actions">
                    <button id="sell-cancel-transaction" class="btn-cancel">H·ªßy</button>
                    <button id="sell-confirm-transaction" class="btn-confirm">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- L·ªãch s·ª≠ giao d·ªãch -->
    <div class="trading-history">
        <div class="history-header">
            <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
            <div class="history-filter">
                <select id="transaction-type-filter">
                    <option value="all">T·∫•t c·∫£ giao d·ªãch</option>
                    <option value="buy">Mua</option>
                    <option value="sell">B√°n</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√£ giao d·ªãch</th>
                        <th>Ng√†y</th>
                        <th>M√£ c·ªï phi·∫øu</th>
                        <th>Lo·∫°i giao d·ªãch</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√°</th>
                        <th>T·ªïng gi√° tr·ªã</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transaction_history %}
                    <tr class="transaction-row ">
                        <td>#{{ transaction.id }}</td>
                        <td>{{ transaction.time|date:"d/m/Y H:i" }}</td>
                        <td>{{ transaction.stock_code }}</td>
                        <td class="transaction-type ">
                            {% if transaction.is_sell %} <span class="type-sell">B√°n</span> {% else %} <span class="type-buy">Mua</span> {% endif %}
                        </td>
                        <td>{{ transaction.amount }}</td>
                        <td>{{ transaction.price|intcomma }} VND</td>
                        <td>{{ transaction.total_value|intcomma }} VND</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="no-data">Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // X·ª≠ l√Ω tabs Mua/B√°n
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            tabButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Hide all tab contents
            tabContents.forEach(content => content.classList.remove('active'));
            // Show the selected tab content
            const tabId = this.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });

    // ==== X·ª¨ L√ù MUA C·ªî PHI·∫æU ====
    const buyStockCode = document.getElementById('buy-stock-code');
    const buyStockPriceInput = document.getElementById('buy-stock-price');
    const buyStockAmountInput = document.getElementById('buy-stock-amount');
    const buyTotalValueElement = document.getElementById('buy-total-value');
    const buyForm = document.getElementById('buy-stock-form');

    const buyModal = document.getElementById('confirmation-modal');
    const buyCloseModal = buyModal.querySelector('.close-modal');
    const buyCancelBtn = document.getElementById('cancel-transaction');
    const buyConfirmBtn = document.getElementById('confirm-transaction');

    // L·∫•y gi√° c·ªï phi·∫øu khi thay ƒë·ªïi m√£
    buyStockCode.addEventListener("change", function() {
        const stockCode = buyStockCode.value;
        if (stockCode){
            fetchStockPrice(stockCode, buyStockPriceInput, buyStockAmountInput, buyTotalValueElement);
        } else {
            alert(`Kh√¥ng t√¨m th·∫•y m√£ c·ªï phi·∫øu`);
        }
    });
    
    // C·∫≠p nh·∫≠t t·ªïng gi√° tr·ªã khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
    buyStockAmountInput.addEventListener('input', function() {
        updateTotalValue(buyStockPriceInput, buyStockAmountInput, buyTotalValueElement);
    });
    
    // Hi·ªÉn th·ªã modal x√°c nh·∫≠n khi submit form mua
    buyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const stockCode = buyStockCode.options[buyStockCode.selectedIndex].text;
        const stockPrice = buyStockPriceInput.value;
        const stockAmount = buyStockAmountInput.value;
        const totalValue = buyTotalValueElement.textContent.replace(' VND', '');
        
        // C·∫≠p nh·∫≠t th√¥ng tin v√†o modal
        document.getElementById('confirm-stock-code').textContent = stockCode;
        document.getElementById('confirm-stock-price').textContent = stockPrice;
        document.getElementById('confirm-stock-amount').textContent = stockAmount;
        document.getElementById('confirm-total-value').textContent = totalValue;
        
        // Hi·ªÉn th·ªã modal
        buyModal.style.display = 'block';
    });
    
    // X·ª≠ l√Ω s·ª± ki·ªán modal mua
    buyCloseModal.addEventListener('click', function() {
        buyModal.style.display = 'none';
    });
    
    buyCancelBtn.addEventListener('click', function() {
        buyModal.style.display = 'none';
    });
    
    buyConfirmBtn.addEventListener('click', function() {
        // Ti·∫øn h√†nh submit form
        buyModal.style.display = 'none';
        buyForm.submit();
    });
    
    // ==== X·ª¨ L√ù B√ÅN C·ªî PHI·∫æU ====
    const sellStockCode = document.getElementById('sell-stock-code');
    const sellStockPriceInput = document.getElementById('sell-stock-price');
    const sellStockAmountInput = document.getElementById('sell-stock-amount');
    const sellTotalValueElement = document.getElementById('sell-total-value');
    const ownedAmountElement = document.getElementById('owned-amount');
    const sellForm = document.querySelector('#sell-tab .trading-form');

    const sellModal = document.getElementById('sell-confirmation-modal');
    const sellCloseModal = sellModal.querySelector('.close-modal');
    const sellCancelBtn = document.getElementById('sell-cancel-transaction');
    const sellConfirmBtn = document.getElementById('sell-confirm-transaction');
    
    // X·ª≠ l√Ω khi ch·ªçn c·ªï phi·∫øu ƒë·ªÉ b√°n
    sellStockCode.addEventListener('change', function() {
        const stockCode = this.value;
        if(stockCode) {
            // L·∫•y s·ªë l∆∞·ª£ng ƒëang s·ªü h·ªØu t·ª´ option text
            const optionText = this.options[this.selectedIndex].text;
            const ownedMatch = optionText.match(/S·ªü h·ªØu: (\d+)/);
            const ownedAmount = ownedMatch ? ownedMatch[1] : '0';
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·ªü h·ªØu hi·ªÉn th·ªã
            ownedAmountElement.textContent = ownedAmount;
            
            // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng b√°n t·ªëi ƒëa
            sellStockAmountInput.setAttribute('max', ownedAmount);
            
            // Fetch gi√° hi·ªán t·∫°i
            fetchStockPrice(stockCode, sellStockPriceInput, sellStockAmountInput, sellTotalValueElement);
        } else {
            ownedAmountElement.textContent = '0';
            sellStockPriceInput.value = '';
            updateTotalValue(sellStockPriceInput, sellStockAmountInput, sellTotalValueElement);
        }
    });
    
    // C·∫≠p nh·∫≠t t·ªïng gi√° tr·ªã khi thay ƒë·ªïi s·ªë l∆∞·ª£ng b√°n
    sellStockAmountInput.addEventListener('input', function() {
        // Ki·ªÉm tra n·∫øu s·ªë l∆∞·ª£ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng s·ªü h·ªØu
        const maxAmount = parseInt(this.getAttribute('max') || 0);
        const currentAmount = parseInt(this.value || 0);
        
        if(currentAmount > maxAmount) {
            this.value = maxAmount;
            alert('S·ªë l∆∞·ª£ng b√°n kh√¥ng th·ªÉ v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng ƒëang s·ªü h·ªØu!');
        }
        
        updateTotalValue(sellStockPriceInput, sellStockAmountInput, sellTotalValueElement);
    });
    
    // Hi·ªÉn th·ªã modal x√°c nh·∫≠n khi submit form b√°n
    sellForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if(!sellStockCode.value) {
            alert('Vui l√≤ng ch·ªçn m√£ c·ªï phi·∫øu ƒë·ªÉ b√°n!');
            return;
        }
        
        if(!sellStockAmountInput.value || parseInt(sellStockAmountInput.value) <= 0) {
            alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
            return;
        }
        
        const stockCode = sellStockCode.options[sellStockCode.selectedIndex].text.split(' - ')[0];
        const stockPrice = sellStockPriceInput.value;
        const stockAmount = sellStockAmountInput.value;
        const totalValue = sellTotalValueElement.textContent.replace(' VND', '');
        
        // C·∫≠p nh·∫≠t th√¥ng tin v√†o modal
        document.getElementById('sell-confirm-stock-code').textContent = stockCode;
        document.getElementById('sell-confirm-stock-price').textContent = stockPrice;
        document.getElementById('sell-confirm-stock-amount').textContent = stockAmount;
        document.getElementById('sell-confirm-total-value').textContent = totalValue;
        
        // Hi·ªÉn th·ªã modal
        sellModal.style.display = 'block';
    });
    
    // X·ª≠ l√Ω s·ª± ki·ªán modal b√°n
    sellCloseModal.addEventListener('click', function() {
        sellModal.style.display = 'none';
    });
    
    sellCancelBtn.addEventListener('click', function() {
        sellModal.style.display = 'none';
    });
    
    sellConfirmBtn.addEventListener('click', function() {
        // Th√™m action URL cho form b√°n
        // sellForm.action = "{% url 'userLogin:sell_stock' %}";
        
        // Ti·∫øn h√†nh submit form
        sellModal.style.display = 'none';
        sellForm.submit();
    });
    
    // ƒê√≥ng modal khi click b√™n ngo√†i
    window.addEventListener('click', function(e) {
        if (e.target == buyModal) {
            buyModal.style.display = 'none';
        }
        if (e.target == sellModal) {
            sellModal.style.display = 'none';
        }
    });
    
    // ==== COMMON FUNCTIONS ====
    
    // H√†m l·∫•y gi√° c·ªï phi·∫øu t·ª´ API
    function fetchStockPrice(stockCode, priceInput, amountInput, totalElement) {
        fetch(`/api/stock-price/${stockCode}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            priceInput.value = formatPrice(data.ref_price);
            updateTotalValue(priceInput, amountInput, totalElement);
        })
        .catch(error => {
            console.error('Error fetching stock price:', error);
            priceInput.value = 'Kh√¥ng th·ªÉ l·∫•y gi√°';
        });
    }
    
    // H√†m t√≠nh t·ªïng gi√° tr·ªã
    function updateTotalValue(priceInput, amountInput, totalElement) {
        const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
        const amount = parseInt(amountInput.value) || 0;
        const total = price * amount;
        
        totalElement.textContent = formatPrice(total) + ' VND';
    }
    
    // H√†m ƒë·ªãnh d·∫°ng gi√° ti·ªÅn
    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
});
</script>
{% endblock %}