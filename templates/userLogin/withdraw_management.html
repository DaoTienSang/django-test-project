{% extends 'userLogin/base_sidebar.html' %}

{% load humanize %}
{% load static %}

{% block title %}Qu·∫£n l√Ω R√∫t ti·ªÅn - SmartTrade{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'userLogin/css/withdraw_management.css' %}">
{% endblock %}

{% block main-content %}
<main class="withdraw-content">
    <div class="withdraw-header">
        <h2>Qu·∫£n l√Ω R√∫t ti·ªÅn</h2>
    </div>

    <!-- Th·∫ª th√¥ng tin v√≠ -->
    <div class="wallet-info-cards">
        <div class="wallet-card">
            <div class="wallet-icon">üí∞</div>
            <div class="wallet-details">
                <h3>S·ªë d∆∞ kh·∫£ d·ª•ng</h3>
                <p class="wallet-amount">{{ user.balance|intcomma}} VND</p>
            </div>
        </div>
        <div class="wallet-card">
            <div class="wallet-icon">üì§</div>
            <div class="wallet-details">
                <h3>T·ªïng r√∫t th√°ng n√†y</h3>
                <p class="wallet-amount">{{amount_withdraw_amonth|intcomma}} VND</p>
            </div>
        </div>
    </div>

    <!-- Form r√∫t ti·ªÅn -->
    <div class="withdraw-form-container">
        <div class="form-header">
            <h3>Th√¥ng tin r√∫t ti·ªÅn</h3>
        </div>
        <form class="withdraw-form" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="withdraw-amount">S·ªë ti·ªÅn r√∫t (VND)</label>
                <input name="withdraw-amount" type="text" id="withdraw-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn b·∫°n mu·ªën r√∫t...">
                <p class="info-text">S·ªë ti·ªÅn t·ªëi thi·ªÉu: 100,000 VND</p>
                <label for="withdraw-description">N·ªôi dung</label>
                <textarea name="withdraw-description" id="withdraw-description" placeholder="Nh·∫≠p n·ªôi dung r√∫t ti·ªÅn..." required></textarea>
            </div>

            <div class="form-group">
                <label for="bank-info">Th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng</label>
                <select name="bank-info" id="bank-info">
                    <option value="">Ch·ªçn t√†i kho·∫£n ng√¢n h√†ng</option>
                    {% for bank in user_banks %}
                    <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_number }}</option>
                    {% endfor %}
                </select>
                <a href="#" class="add-bank-link">+ Th√™m t√†i kho·∫£n m·ªõi</a>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-submit">X√°c nh·∫≠n r√∫t ti·ªÅn</button>
            </div>
        </form>
    </div>

    <!-- L·ªãch s·ª≠ r√∫t ti·ªÅn -->
    <div class="withdraw-history">
        <div class="history-header">
            <h3>L·ªãch s·ª≠ r√∫t ti·ªÅn</h3>
            <div class="history-filter">
                <select>
                    <option>T·∫•t c·∫£</option>
                    <option>Ho√†n th√†nh</option>
                    <option>ƒêang x·ª≠ l√Ω</option>
                    <option>B·ªã h·ªßy</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√£ giao d·ªãch</th>
                        <th>Ng√†y</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Ng√¢n h√†ng</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in withdraw_history %}
                    <tr>
                        <td>#WIT-{{ transaction.id }}</td>
                        <td>{{ transaction.time|date:"d/m/Y H:i" }}</td>
                        <td>- {{ transaction.amount|intcomma }} VND</td>
                        <td>{{ transaction.bank_info }}</td>
                        <td class="status {{ transaction.status_class }}"><p>{{ transaction.status_text }}</p></td>
                        <td><button class="btn-detail" data-id="{{ transaction.id }}">Chi ti·∫øt</button></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="no-data">Ch∆∞a c√≥ giao d·ªãch r√∫t ti·ªÅn n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal th√™m t√†i kho·∫£n ng√¢n h√†ng -->
    <div id="add-bank-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Th√™m t√†i kho·∫£n ng√¢n h√†ng</h3>
            <form id="add-bank-form" method="post" action="{% url 'userLogin:add_bank_account' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="bank-name">T√™n ng√¢n h√†ng</label>
                    <select name="bank-name" id="bank-name" required>
                        <option value="">Ch·ªçn ng√¢n h√†ng</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="ACB">ACB</option>
                        <option value="TPBank">TPBank</option>
                        <option value="Sacombank">Sacombank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="account-number">S·ªë t√†i kho·∫£n</label>
                    <input type="text" id="account-number" name="account-number" required>
                </div>
                <div class="form-group">
                    <label for="account-name">T√™n ch·ªß t√†i kho·∫£n</label>
                    <input type="text" id="account-name" name="account-name" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Th√™m t√†i kho·∫£n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal chi ti·∫øt giao d·ªãch -->
    <div id="transaction-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Chi ti·∫øt giao d·ªãch</h3>
            <div id="transaction-detail-content">
                <!-- N·ªôi dung chi ti·∫øt giao d·ªãch s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
        </div>
    </div>
</main>

<script>
    // JavaScript ƒë·ªÉ x·ª≠ l√Ω modal th√™m t√†i kho·∫£n ng√¢n h√†ng v√† chi ti·∫øt giao d·ªãch
    document.addEventListener('DOMContentLoaded', function() {
        // - Format s·ªë ti·ªÅn khi nh·∫≠p
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        if (withdrawAmountInput) {
            withdrawAmountInput.addEventListener('input', function(e) {
                // X√≥a t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
                let value = this.value.replace(/\D/g, '');
                // Format v·ªõi d·∫•u ph·∫©y ngƒÉn c√°ch h√†ng ngh√¨n
                if (value) {
                    this.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }else {
                    this.value = '';
                }
            });
        }
        // - Th√™m t√†i kho·∫£n ng√¢n h√†ng
        const addBankLink = document.querySelector('.add-bank-link');
        const addBankModal = document.getElementById('add-bank-modal');
        const closeButtons = document.querySelectorAll('.close');
        
        // M·ªü modal th√™m t√†i kho·∫£n
        addBankLink.addEventListener('click', function(e) {
            e.preventDefault();
            addBankModal.style.display = 'block';
        });
        
        // ƒê√≥ng modal
        closeButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                addBankModal.style.display = 'none';
                transactionDetailModal.style.display = 'none';
            });
        });
        
        // - xem chi ti·∫øt giao d·ªãch
        const detailButtons = document.querySelectorAll('.btn-detail');
        const transactionDetailModal = document.getElementById('transaction-detail-modal');
        // X·ª≠ l√Ω n√∫t chi ti·∫øt
        detailButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const transactionId = this.getAttribute('data-id');
                // G·ªçi API ƒë·ªÉ l·∫•y chi ti·∫øt giao d·ªãch
                fetchTransactionDetail(transactionId);
                transactionDetailModal.style.display = 'block';
            });
        });
        
        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.addEventListener('click', function(event) {
            if (event.target == addBankModal) {
                addBankModal.style.display = 'none';
            }
            if (event.target == transactionDetailModal) {
                transactionDetailModal.style.display = 'none';
            }
        });

        // H√†m l·∫•y nƒÉm, th√°ng, ng√†y, gi·ªù, ph√∫t, gi√¢y
        function formatISODate(isoString) {
            const date = new Date(isoString);

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Th√°ng t·ª´ 0-11, c·∫ßn +1
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // H√†m l·∫•y chi ti·∫øt giao d·ªãch
        function fetchTransactionDetail(id) {
            // Gi·∫£ ƒë·ªãnh API endpoint
            fetch(`/api/transaction/${id}/`)
                .then(response => response.json())
                .then(data => {
                    const contentDiv = document.getElementById('transaction-detail-content');
                    contentDiv.innerHTML = `
                        <div class="detail-item">
                            <span class="label">M√£ giao d·ªãch:</span>
                            <span class="value">#WIT-${data.id}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Ng√†y giao d·ªãch:</span>
                            <span class="value">${formatISODate(data.time)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">S·ªë ti·ªÅn:</span>
                            <span class="value">+ ${data.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")} VND</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">S·ªë ti·ªÅn c√≤n l·∫°i:</span>
                            <span class="value">${data.balance_after.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")} VND</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Ng√¢n h√†ng:</span>
                            <span class="value">${data.bank_info.bank_name}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">S·ªë t√†i kho·∫£n:</span>
                            <span class="value">${data.bank_info.account_number}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">T√™n ch·ªß t√†i kho·∫£n:</span>
                            <span class="value">${data.bank_info.account_name}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Tr·∫°ng th√°i:</span>
                            <span class="value status-${data.status.toLowerCase()}">${data.status_display}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Ghi ch√∫:</span>
                            <span class="value">${data.description || 'Kh√¥ng c√≥'}</span>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching transaction details:', error);
                });
        }
        
    });
</script>
{% endblock %}